 <!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Video encoder</title>

	<link rel="stylesheet" type="text/css" href="encode.css">
	<script src="../js/third-party/jquery-1.8.1.js" type="text/javascript"></script>
	<script src="../js/third-party/base64.js" type="text/javascript"></script>
	<script src="../js/third-party/underscore-min.js" type="text/javascript"></script>
	<script src="../js/third-party/FileSaver.js" type="text/javascript"></script>
	<script src="../js/tileset.js" type="text/javascript"></script>
</head>

<body class="loading">
	<div class="loading-messsage">Loading...</div>
	
	<div>
		<button id="encoding-button">Start encoding</button>
	</div>

	<script>
		$(document).ready(function(){
			$.ajax('../data/unencoded-video-20x15-30fps.json').then(function(json){
				window.originalVideo = json;
				$('body').removeClass('loading');
			});
			
			$('#encoding-button').click(function(){
				var converted = _.pick(originalVideo, 'tileCountX', 'tileCountY', 'frameRate');
				converted.format = 'TILE_MAP';
				converted.frames = originalVideo.frames.map(function(origFrame){
					var destFrame = {
						number: origFrame.number,
						tiles: [],
						map: []
					};
					
					var tileNumbers = {};
					origFrame.tiles.forEach(function(encodedTile, index){
						var tileNumber = tileNumbers[encodedTile];
						if (_.isUndefined(tileNumber)) {
							tileNumber = destFrame.tiles.length;
							destFrame.tiles.push(encodedTile);
							tileNumbers[encodedTile] = tileNumber;
						}
						
						var tx = index % originalVideo.tileCountX;
						var ty = Math.floor(index / originalVideo.tileCountX);
						if (!destFrame.map[ty]) {
							destFrame.map[ty] = [];
						}
						destFrame.map[ty][tx] = tileNumber;
					});
					
					return destFrame;
				});
				
				converted.stats = {
					maxTileCount: _.chain(converted.frames).pluck('tiles').pluck('length').max().value(),
					frameCount: converted.frames.length,
					globalTileCount: _.chain(converted.frames).pluck('tiles').pluck('length').reduce(function(s, n){ return s + n }, 0).value(),
					globallyUniqueTileCount: _.chain(converted.frames).pluck('tiles').reduce(function(o, ts){ 
						return ts.reduce(function(o2, t){ o2[t] = true; return o2; }, o);
					}, {}).keys().value().length
				};
				converted.stats.estimatedMaximumSize = 
						converted.stats.frameCount * converted.tileCountX * converted.tileCountX + 
						converted.stats.globalTileCount * 8;
				converted.stats.averageTilesPerFrame = Math.round(converted.stats.globalTileCount / converted.stats.frameCount);
				
				window.convertedVideo = converted;
				console.info('Done!');
				console.info(converted.stats);

				// Save encoded video as JSON
				var json = JSON.stringify(converted, null, '\t');
				var blob = new Blob([json], {type: "text/plain;charset=utf-8"});
				saveAs(blob, "encoded-video-" + converted.tileCountX + 'x' + converted.tileCountY + '-' + converted.frameRate + 'fps.json');
			});
		})
	</script>
</body>

</html> 